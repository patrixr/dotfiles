---

# ----------------------------------------------------
# HOMEBREW
# ----------------------------------------------------

- name: Brew installations
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Install Cask Apps
      community.general.homebrew_cask:
        name: '{{ item }}'
        state: latest
      loop:
        - redisinsight
        - docker

    - name: Install packages
      community.general.homebrew:
        name: '{{ item }}'
        state: latest
      loop:
        - nvm
        - zsh
        - terraform
        - pandoc
        - imagemagick
        - tmux
        - ripgrep
        - coreutils
        - emacs
        - fd
        - ffmpeg

# ----------------------------------------------------
# ZSHRC Sync
# ----------------------------------------------------

- name: ZSHRC Sync
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - ansible.builtin.blockinfile:
        path: ~/.zshrc
        block: "{{ item }}"
      with_items:
        - "{{lookup('ansible.builtin.file', '../configs/zshrc.sh') }}"

# ----------------------------------------------------
# NVM/NODE/NPM/PNPM Setup
# ----------------------------------------------------

- name: NPM/PNPM Setup
  hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Install latest node
      shell: source ~/.nvm/nvm.sh && nvm install node

    - name: Source ~/.nvm/nvm.sh
      shell: source ~/.nvm/nvm.sh && echo $PATH
      register: updated_path_output
      args:
        executable: /bin/bash

    - name: Set updated PATH as a fact
      set_fact:
        updated_path: "{{ updated_path_output.stdout }}"

    - name: Global installs via NPM
      community.general.npm:
        name: "{{ item }}"
        global: true
        state: latest
      loop:
        - pnpm
        - vercel
        - typescript
        - typescript-language-server
        - tide
        - prettier
      environment:
        PATH: "{{ updated_path }}"

# ----------------------------------------------------
# DOOM EMACS
# ----------------------------------------------------

- name: Clone Doom Emacs
  hosts: localhost
  tasks:
    - name: Clone Doom Emacs
      block:
        - name: Clone Doom Emacs repository
          git:
            repo: https://github.com/doomemacs/doomemacs
            dest: ~/.config/emacs
            depth: 1

        - name: Copy contents of configs/doom folder to ~/.config/doom/
          ansible.builtin.copy:
            src: ../configs/doom/
            dest: ~/.config/doom/
            remote_src: yes

        - name: Delete ~/.emacs.d folder
          ansible.builtin.file:
            path: ~/.emacs.d
            state: absent

        - name: Check if doom is installed
          shell: command -v doom >/dev/null 2>&1
          register: is_doom_installed
          ignore_errors: yes

        - name: Install Doom Emacs for the first time
          shell: ~/.config/emacs/bin/doom install
          when: is_doom_installed.rc != 0

        - name: Run doom sync
          shell: doom sync
